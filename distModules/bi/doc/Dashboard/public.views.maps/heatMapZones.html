<!DOCTYPE html>

<html>
<head>
  <title>heatMapZones.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>heatMapZones.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h3 id="heatmap-zones-view-manages-the-view-by-geographic-bound-for-the-explorers">HeatMap Zones View: Manages the view by Geographic Bound for the explorers</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>define([
    <span class="hljs-string">'jquery'</span>,
    <span class="hljs-string">'underscore'</span>,
    <span class="hljs-string">'backbone'</span>,
    <span class="hljs-string">'config/appConfig'</span>
], <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$, _, Backbone, Config</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Creating Map view, used for showing the Explored Zones Map when we organize by Geographic Bound</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> MapView = Backbone.View.extend({
        el: <span class="hljs-string">'#result'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Initializes the map element, with his explorers (and his gradients), and the bounds</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        initialize: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">options</span>) </span>{
            <span class="hljs-keyword">if</span> (_.size(<span class="hljs-keyword">this</span>.$(<span class="hljs-string">'#map'</span>)) === <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">this</span>.$el.append(<span class="hljs-string">'&lt;div id=\'map\'&gt;&lt;/div&gt;'</span>);
            }
            <span class="hljs-keyword">this</span>.$map = <span class="hljs-keyword">this</span>.$(<span class="hljs-string">'#map'</span>);

            <span class="hljs-keyword">this</span>.data = options.chartData;
            <span class="hljs-keyword">this</span>.explorers = [];
            <span class="hljs-keyword">this</span>.gradientExplorers = [];
            <span class="hljs-keyword">this</span>.bounds = [];
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Sets hexadecimal random color, used for the gradient</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        getRandomColor: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> letters = <span class="hljs-string">'0123456789ABCDEF'</span>.split(<span class="hljs-string">''</span>);
            <span class="hljs-keyword">var</span> color = <span class="hljs-string">'#'</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">6</span>; i++) {
                color += letters[<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">16</span>)];
            }
            <span class="hljs-keyword">return</span> color;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Specifies a random color for each explorer in the map to show</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        getRandomGradient: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">explorerName</span>) </span>{
            <span class="hljs-keyword">var</span> gradientExplorer = _.findWhere(<span class="hljs-keyword">this</span>.gradientExplorers, {explorerName: explorerName});
            <span class="hljs-keyword">if</span> (_.isUndefined(gradientExplorer)) {
                <span class="hljs-keyword">var</span> newGradientExplorer = {
                    explorerName: explorerName,
                    gradient: {
                        <span class="hljs-number">0.55</span>: <span class="hljs-keyword">this</span>.getRandomColor(),
                        <span class="hljs-number">0.75</span>: <span class="hljs-keyword">this</span>.getRandomColor()
                    }
                };</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <ul>
<li>Pushing the Explorers List with his new gradient</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">this</span>.gradientExplorers.push(newGradientExplorer);
                <span class="hljs-keyword">return</span> newGradientExplorer.gradient;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> gradientExplorer.gradient;
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Calls for process the Data, rendering the both layers: the map and the heat layer, and the Legend</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        render: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">this</span>.processData();
            <span class="hljs-keyword">this</span>.renderMap();
            <span class="hljs-keyword">this</span>.renderHeatMapLayers();
            <span class="hljs-keyword">this</span>.renderLegend();
            <span class="hljs-keyword">this</span>.map.fitBounds(<span class="hljs-keyword">this</span>.bounds);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Process the assigned data</p>
<ul>
<li>For each element on the data, their stats are picked</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        processData: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;
            _.each(<span class="hljs-keyword">this</span>.data, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">elementData</span>) </span>{
                <span class="hljs-keyword">var</span> data = elementData.data,
                    bounds = elementData.group.bounds,
                    groupName = elementData.group.groupName;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <ul>
<li>Controls if each element has Lat and Lng in their bounds and is not Undefined</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (_.size(bounds[<span class="hljs-number">0</span>]) == <span class="hljs-number">2</span> &amp;&amp;
                    _.size(bounds[<span class="hljs-number">1</span>]) == <span class="hljs-number">2</span> &amp;&amp; !_.isUndefined(groupName)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <ul>
<li>Picks the explorer position</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">var</span> explorer = _.findWhere(that.explorers, {explorerName: groupName}),
                        center = L.latLngBounds(bounds).getCenter();
                    <span class="hljs-keyword">var</span> bounds = [
                        center.lat,
                        center.lng
                    ];
                    that.bounds.push(bounds);
                    bounds.push(data);</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <ul>
<li>If the explorer is Undefined, is pushed in the list with his data</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">if</span> (_.isUndefined(explorer)) {
                        that.explorers.push({
                            explorerName: groupName,
                            gradient: that.getRandomGradient(groupName),
                            bounds: [bounds]
                        });</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <ul>
<li>If is not Undefined, his index is picked from the list, and their bounds are pushed</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">var</span> index = _.indexOf(that.explorers, explorer);
                        that.explorers[index].bounds.push(bounds);
                    }
                }
            });
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Renders the Map Layer. Specifies the min and max zoom values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        renderMap: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> baseLayer = L.tileLayer(
                Config.URL_OPENSTREETMAP, {
                    minZoom: <span class="hljs-number">2</span>,
                    maxZoom: <span class="hljs-number">16</span>
                }
            );</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <ul>
<li>If there is no data to show, is rendered a big world map empty</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (_.size(<span class="hljs-keyword">this</span>.data) &lt; <span class="hljs-number">1</span>) {
                <span class="hljs-keyword">this</span>.map = <span class="hljs-keyword">new</span> L.Map(<span class="hljs-keyword">this</span>.$map[<span class="hljs-number">0</span>], {
                    center: <span class="hljs-keyword">new</span> L.LatLng(<span class="hljs-number">30</span>, -<span class="hljs-number">10</span>),
                    zoom: <span class="hljs-number">2</span>,
                    layers: [baseLayer]
                });</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <ul>
<li>If there is some data, is rendered and centered on the first bounds element</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">this</span>.map = <span class="hljs-keyword">new</span> L.Map(<span class="hljs-keyword">this</span>.$map[<span class="hljs-number">0</span>], {
                    center: <span class="hljs-keyword">new</span> L.LatLng(<span class="hljs-keyword">this</span>.explorers[<span class="hljs-number">0</span>].bounds[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>], <span class="hljs-keyword">this</span>.explorers[<span class="hljs-number">0</span>].bounds[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]),
                    zoom: <span class="hljs-number">10</span>,
                    layers: [baseLayer]
                });
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Renders the Heat Layers. Configuring the Heat Zone for each different explorer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        renderHeatMapLayers: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;
            _.each(<span class="hljs-keyword">this</span>.explorers, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">explorer</span>) </span>{
                <span class="hljs-keyword">var</span> cfgHeatMap = {
                    maxZoom: <span class="hljs-number">12</span>,
                    minOpacity: <span class="hljs-number">.8</span>,
                    max: <span class="hljs-number">.4</span>,
                    blur: <span class="hljs-number">50</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <ul>
<li>Sets a random gradient to each explorer</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    gradient: that.getRandomGradient(explorer.explorerName)
                };</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <ul>
<li>Adds this Layer to the Map Layer</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>                L.heatLayer(
                    explorer.bounds,
                    cfgHeatMap
                ).addTo(that.map);
            });
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Renders the Legend. Creates the DOM element for the Legend</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        renderLegend: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> legend = L.control({position: <span class="hljs-string">'bottomleft'</span>});
            <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;

            legend.onAdd = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">var</span> div = L.DomUtil.create(<span class="hljs-string">'div'</span>, <span class="hljs-string">'info legend'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <ul>
<li>For each different explorer, it creates a new Legend Element, with his name and gradient</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>                _.each(that.explorers, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">explorer</span>) </span>{
                    <span class="hljs-keyword">var</span> explorerName = explorer.explorerName,
                        gradient = _.values(explorer.gradient);
                    div.innerHTML +=
                        explorerName + <span class="hljs-string">"&lt;i style='background: linear-gradient(-45deg,"</span> + gradient[<span class="hljs-number">1</span>] + <span class="hljs-string">","</span> + gradient[<span class="hljs-number">0</span>] + <span class="hljs-string">")'&gt;&lt;/i&gt;&lt;br/&gt;"</span>;
                });
                <span class="hljs-keyword">return</span> div;
            };</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <ul>
<li>Adds this Layer to the Map Layer</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>            legend.addTo(<span class="hljs-keyword">this</span>.map);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Removes the map, explorers, gradients and bounds</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        remove: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">this</span>.explorers = [];
            <span class="hljs-keyword">this</span>.gradientExplorers = [];
            <span class="hljs-keyword">this</span>.bounds = [];
            <span class="hljs-keyword">this</span>.$map.remove();
        }
    });
    <span class="hljs-keyword">return</span> MapView;
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
